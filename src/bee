#!/usr/bin/env bash
# shellcheck disable=SC1090
set -euo pipefail
IFS=$'\n\t'

BEE_QUIET=0
bee::log_echo() { ((!BEE_QUIET)) && echo "$*"; }
bee::log() { bee::log_echo "🐝 $*"; }
bee::log_info() {
  bee::log_echo "################################################################################"
  bee::log "$*"
  bee::log_echo "################################################################################"
}
bee::log_func() { bee::log_info "${FUNCNAME[1]} $*"; }
bee::log_warn() { echo "🟠 $*" >&2; }
bee::log_error() { echo "🔴 $*" >&2; }
bee::log_var() { echo "${!1}"; }

BEE_SYSTEM_HOME="${BASH_SOURCE[0]}"
while [[ -L "${BEE_SYSTEM_HOME}" ]]; do
  BEE_SYSTEM_HOME="$(readlink "${BEE_SYSTEM_HOME}")"
done
BEE_SYSTEM_HOME="$(cd "$(dirname "${BEE_SYSTEM_HOME}")/.." && pwd)"

[[ ! -f "${BEE_RC:="${HOME}/.beerc"}" ]] && cat << 'EOF' > "${BEE_RC}"
BEE_ORIGIN="https://github.com/sschmid/bee.git"
BEE_WIKI="https://github.com/sschmid/bee/wiki"
BEE_LATEST_VERSION_PATH="https://raw.githubusercontent.com/sschmid/bee/main/version.txt"
BEE_LATEST_VERSION_CACHE_EXPIRE=14400 # 4h
BEE_HUBS=("https://github.com/sschmid/beehub.git")
BEE_CACHES_PATH="${HOME}/.bee/caches"
BEE_PLUGINS_PATHS=("${BEE_CACHES_PATH}/plugins")
EOF
source "${BEE_RC}"

[[ -v BEE_FILE ]] && source "${BEE_FILE}"

if [[ -v BEE_VERSION ]]; then
  BEE_HOME="${BEE_CACHES_PATH}/bee/${BEE_VERSION}"
  [[ ! -d "${BEE_HOME}" ]] &&
    git -c advice.detachedHead=false clone -q --depth 1 --branch "${BEE_VERSION}" "${BEE_ORIGIN}" "${BEE_HOME}"
else
  BEE_HOME="${BEE_SYSTEM_HOME}"
fi

if [[ -f "${BEE_HOME}/src/os/${BEE_OSTYPE:=${OSTYPE%%[[:digit:]]*}}.bash" ]]; then
  source "${BEE_HOME}/src/os/${BEE_OSTYPE}.bash"
else
  bee::log_warn "Missing platform support for ${BEE_OSTYPE} (${OSTYPE})"
fi

source "${BEE_HOME}/src/bee-run.bash"
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  bee::run "$@"
fi
