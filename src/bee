#!/usr/bin/env bash
#
# 🐝 bee - plugin-based bash automation
#
# Shell Style Guide
# https://google.github.io/styleguide/shell.xml
#
# "bash strict mode"
# http://redsymbol.net/articles/unofficial-bash-strict-mode/

set -euo pipefail
IFS=$'\n\t'

################################################################################
# log
################################################################################

BEE_SILENT=false

log() {
  if [[ ${BEE_SILENT} == false ]]; then
    echo "🐝 $*"
  fi
}

log_info() {
  if [[ ${BEE_SILENT} == false ]]; then
    echo ""
    echo "################################################################################"
    echo "🐝 $*"
    echo "################################################################################"
  fi
}

log_warn() {
  echo "⚠️ WARNING: $*" >&2
}

log_error() {
  echo "❌ ERROR: $*" >&2
}

log_func() {
  log_info "${FUNCNAME[1]} $*"
}

log_var() {
  echo "${!1}"
}

################################################################################
# init
################################################################################

resolve_file() {
  local current_dir="${PWD}"
  local path="$1"
  while [[ -L "${path}" ]]; do
    local link="$(readlink "${path}")"
    cd "$(dirname "${path}")"
    cd "$(dirname "${link}")"
    path="${link}"
  done
  cd "${current_dir}"
  echo "${path}"
}

BEE_SYSTEM_HOME="$(dirname "$(dirname "$(resolve_file "${BASH_SOURCE[0]}")")")"
BEE_RESOURCES=.bee

if [[ ! -f "${HOME}/.beerc" ]]; then
  echo '#!/usr/bin/env bash
BEE_PLUGIN_REGISTRIES=(
  git@github.com:sschmid/bee-plugins.git
)' > "${HOME}/.beerc"
fi
source "${HOME}/.beerc"

if [[ -v BEE_RC ]]; then
  source "${BEE_RC}"
else
  if [[ -f .beerc ]]; then
    BEE_RC=.beerc
    source "${BEE_RC}"
  fi
fi

if [[ -v BEE_VERSION ]]; then
  BEE_HOME="${HOME}/.bee/caches/bee/${BEE_VERSION}"
  if [[ ! -d "${BEE_HOME}" ]]; then
    git -c advice.detachedHead=false clone -q --depth 1 --branch "${BEE_VERSION}" git@github.com:sschmid/bee.git "${BEE_HOME}"
  fi
else
  BEE_HOME="${BEE_SYSTEM_HOME}"
fi

source "${BEE_HOME}/src/bee.sh"
