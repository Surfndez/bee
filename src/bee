#!/usr/bin/env bash
# 🐝 bee - plugin-based bash automation
#
# Shell Style Guide
# https://google.github.io/styleguide/shell.xml
#
# "bash strict mode"
# http://redsymbol.net/articles/unofficial-bash-strict-mode

set -euo pipefail
IFS=$'\n\t'

################################################################################
# log
################################################################################

BEE_QUIET=0

bee::log_echo() {
  if ((!BEE_QUIET)); then
    echo "$*"
  fi
}

bee::log() {
  bee::log_echo "🐝 $*"
}

bee::log_info() {
  bee::log_echo "################################################################################"
  bee::log "$*"
  bee::log_echo "################################################################################"
}

bee::log_func() {
  bee::log_info "${FUNCNAME[1]} $*"
}

bee::log_warn() {
  echo "🟠 $*" >&2
}

bee::log_error() {
  echo "🔴 $*" >&2
}

bee::log_var() {
  echo "${!1}"
}

################################################################################
# init
################################################################################

BEE_SYSTEM_HOME="${BASH_SOURCE[0]}"
while [[ -L "${BEE_SYSTEM_HOME}" ]]; do
  BEE_SYSTEM_HOME="$(readlink "${BEE_SYSTEM_HOME}")"
done
BEE_SYSTEM_HOME="$(cd "$(dirname "${BEE_SYSTEM_HOME}")/.." && pwd)"

# [[ ! -v BEE_RC ]] && BEE_RC="${HOME}/.beerc"
[[ ! -f "${BEE_RC}" ]] && cat << 'EOF' > "${BEE_RC}"
BEE_ORIGIN="https://github.com/sschmid/bee.git"
BEE_MODULES_PATH="${BEE_SYSTEM_HOME}/src/modules"
BEE_CACHES_PATH="${HOME}/.bee/caches"
BEE_PLUGINS_PATH="${BEE_CACHES_PATH}/plugins"
EOF
# shellcheck disable=SC1090
source "${BEE_RC}"

if [[ -v BEE_FILE ]]; then
  # shellcheck disable=SC1090
  source "${BEE_FILE}"
fi

if [[ -v BEE_VERSION ]]; then
  BEE_HOME="${BEE_CACHES_PATH}/bee/${BEE_VERSION}"
  [[ ! -d "${BEE_HOME}" ]] &&
    git -c advice.detachedHead=false clone -q --depth 1 --branch "${BEE_VERSION}" "${BEE_ORIGIN}" "${BEE_HOME}"
else
  BEE_HOME="${BEE_SYSTEM_HOME}"
fi

# shellcheck disable=SC1090
source "${BEE_HOME}/src/bee-run.bash"

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  bee::run "$@"
fi
