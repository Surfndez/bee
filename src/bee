#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

################################################################################
# log
################################################################################

BEE_QUIET=0

bee::log_echo() {
  if ((!BEE_QUIET)); then
    echo "$*"
  fi
}

bee::log() {
  bee::log_echo "🐝 $*"
}

bee::log_info() {
  bee::log_echo "################################################################################"
  bee::log "$*"
  bee::log_echo "################################################################################"
}

bee::log_func() {
  bee::log_info "${FUNCNAME[1]} $*"
}

bee::log_warn() {
  echo "🟠 $*" >&2
}

bee::log_error() {
  echo "🔴 $*" >&2
}

bee::log_var() {
  echo "${!1}"
}

################################################################################
# modules
################################################################################

BEE_LOAD_MODULE_NAME=""
declare -gA BEE_LOAD_MODULE_LOADED=()

bee::load_module() {
  local module="$1"
  if [[ ! -v BEE_LOAD_MODULE_LOADED["${module}"] ]]; then
    local module_path="${BEE_MODULES_PATH}/bee-${module}.sh"
    if [[ -f "${module_path}" ]]; then
      # shellcheck disable=SC1090
      source "${module_path}"
      BEE_LOAD_MODULE_NAME="${module}"
    else
      BEE_LOAD_MODULE_NAME=""
    fi
    BEE_LOAD_MODULE_LOADED["${module}"]="${BEE_LOAD_MODULE_NAME}"
  else
    BEE_LOAD_MODULE_NAME="${BEE_LOAD_MODULE_LOADED["${module}"]}"
  fi
}

bee::run_module() {
  local module="$1"
  shift
  "bee::${module}" "$@"
}

################################################################################
# plugins
################################################################################

BEE_RESOLVE_PLUGIN_NAME=""
BEE_RESOLVE_PLUGIN_VERSION=""
BEE_RESOLVE_PLUGIN_PATH=""
declare -gA BEE_RESOLVE_PLUGIN_PATH_CACHE=()

bee::resolve_plugin() {
  local plugin="$1"
  BEE_RESOLVE_PLUGIN_NAME="${plugin%:*}"
  BEE_RESOLVE_PLUGIN_VERSION="${plugin##*:}"
  if [[ ! -v BEE_RESOLVE_PLUGIN_PATH_CACHE["${plugin}"] ]]; then
    if [[ "${BEE_RESOLVE_PLUGIN_NAME}" == "${BEE_RESOLVE_PLUGIN_VERSION}" && -d "${BEE_PLUGINS_PATH}/${plugin}" ]]; then
      BEE_RESOLVE_PLUGIN_VERSION="$(basename "$(find "${BEE_PLUGINS_PATH}/${plugin}" -mindepth 1 -type d | sort -rV | head -n 1)")"
    fi
    BEE_RESOLVE_PLUGIN_PATH="${BEE_PLUGINS_PATH}/${BEE_RESOLVE_PLUGIN_NAME}/${BEE_RESOLVE_PLUGIN_VERSION}/${BEE_RESOLVE_PLUGIN_NAME}.sh"
    if [[ -f "${BEE_RESOLVE_PLUGIN_PATH}" ]]; then
      BEE_RESOLVE_PLUGIN_PATH_CACHE["${BEE_RESOLVE_PLUGIN_NAME}:${BEE_RESOLVE_PLUGIN_VERSION}"]="${BEE_RESOLVE_PLUGIN_PATH}"
    else
      BEE_RESOLVE_PLUGIN_NAME=""
      BEE_RESOLVE_PLUGIN_VERSION=""
      BEE_RESOLVE_PLUGIN_PATH=""
    fi
    BEE_RESOLVE_PLUGIN_PATH_CACHE["${plugin}"]="${BEE_RESOLVE_PLUGIN_PATH}"
  else
    BEE_RESOLVE_PLUGIN_PATH="${BEE_RESOLVE_PLUGIN_PATH_CACHE["${plugin}"]}"
  fi
}

BEE_LOAD_PLUGIN_NAME=""
declare -gA BEE_LOAD_PLUGIN_LOADED=()
BEE_LOAD_PLUGIN_MISSING=()

bee::load_plugin() {
  BEE_LOAD_PLUGIN_MISSING=()
  bee::resolve_plugin "$1"
  if [[ -n "${BEE_RESOLVE_PLUGIN_PATH}" ]]; then
    BEE_LOAD_PLUGIN_NAME="${BEE_RESOLVE_PLUGIN_NAME}"
    bee::load_plugin_deps "${BEE_LOAD_PLUGIN_NAME}"
    if [[ ${#BEE_LOAD_PLUGIN_MISSING[@]} -gt 0 ]]; then
      for missing in "${BEE_LOAD_PLUGIN_MISSING[@]}"; do
        bee::log_error "Missing plugin: '${missing}'"
      done
      exit 1
    fi
  else
    BEE_LOAD_PLUGIN_NAME=""
  fi
}

bee::load_plugin_deps() {
  if [[ ! -v BEE_LOAD_PLUGIN_LOADED["${BEE_RESOLVE_PLUGIN_PATH}"] ]]; then
    # shellcheck disable=SC1090
    source "${BEE_RESOLVE_PLUGIN_PATH}"
    # shellcheck disable=SC2034
    BEE_LOAD_PLUGIN_LOADED["${BEE_RESOLVE_PLUGIN_PATH}"]=1
    local deps="${BEE_RESOLVE_PLUGIN_NAME}::deps"
    if [[ $(command -v "${deps}") == "${deps}" ]]; then
      for dep in $("${deps}"); do
        bee::resolve_plugin "${dep}"
        if [[ -n "${BEE_RESOLVE_PLUGIN_PATH}" ]]; then
          bee::load_plugin_deps "${dep}"
        else
          BEE_LOAD_PLUGIN_MISSING+=("${dep}")
        fi
      done
    fi
  fi
}

bee::run_plugin() {
  local plugin="$1"
  shift
  if (($# > 0)); then
    local cmd="$1"
    shift
    "${plugin}::${cmd}" "$@"
  else
    "${plugin}::help"
  fi
}

################################################################################
# run
################################################################################

BEE_RC_LOADED=0

bee::load_beerc() {
  if ((!BEE_RC_LOADED)); then
    # [[ ! -v BEE_RC ]] && BEE_RC="${HOME}/.beerc"
    [[ ! -f "${BEE_RC}" ]] && echo "# default beerc" >"${BEE_RC}"
    # shellcheck disable=SC1090
    source "${BEE_RC}"
    BEE_RC_LOADED=1
  fi
}

bee::batch() {
  for batch in "$@"; do
    local cmd="${batch%% *}"
    local args="${batch#* }"
    if [[ "${args}" != "${cmd}" ]]; then
      # shellcheck disable=SC2046
      bee::run "${cmd}" $(bee::split_args "${args}")
    else
      bee::run "${cmd}"
    fi
  done
}

bee::split_args() {
  local IFS=" "
  # shellcheck disable=SC2068
  for arg in $@; do
    echo "${arg}"
  done
}

bee::run() {
  if (($# > 0)); then
    while (($# > 0)); do
      case "$1" in
        -q | --quiet) BEE_QUIET=1 ;;
        -b | --batch)
          shift
          bee::batch "$@"
          return
          ;;
        --)
          shift
          break
          ;;
        *) break ;;
      esac
      shift
    done

    bee::load_beerc

    bee::load_module "$1"
    if [[ -n "${BEE_LOAD_MODULE_NAME}" ]]; then
      shift
      bee::run_module "${BEE_LOAD_MODULE_NAME}" "$@" # run bee module, e.g. bee update
    else
      bee::load_plugin "$1"
      if [[ -n "${BEE_LOAD_PLUGIN_NAME}" ]]; then
        shift
        bee::run_plugin "${BEE_LOAD_PLUGIN_NAME}" "$@" # run bee plugin, e.g. bee github
      else
        "$@" # run args, e.g. bee echo "message"
      fi
    fi
  else
    echo "bee help"
  fi
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  bee::run "$@"
fi
