#!/usr/bin/env bash
# shellcheck disable=SC1090
set -euo pipefail
IFS=$'\n\t'

: "${BEE_ORIGIN:=https://github.com/sschmid/bee.git}"
: "${BEE_CACHES_PATH:="${HOME}/.bee/caches"}"

: "${BEE_COLOR_SUCCESS:="\033[0;32m"}"
: "${BEE_COLOR_WARN:="\033[0;33m"}"
: "${BEE_COLOR_FAIL:="\033[0;31m"}"
: "${BEE_COLOR_RESET:="\033[0m"}"
: "${BEE_CHECK_SUCCESS:="✔"}"
: "${BEE_CHECK_FAIL:="✗"}"
: "${BEE_RESULT:="➜"}"
: "${BEE_ICON:="🐝"}"
: "${BEE_WARN:="🟠"}"
: "${BEE_ERR:="🔴"}"

declare -ig BEE_QUIET=0
bee::log_echo() { ((BEE_QUIET)) || echo "$*"; }
bee::log() { bee::log_echo "${BEE_ICON} $*"; }
bee::log_info() {
  bee::log_echo "################################################################################"
  bee::log "$*"
  bee::log_echo "################################################################################"
}
bee::log_func() { bee::log_info "${FUNCNAME[1]} $*"; }
bee::log_warn() { echo "🟠 $*" >&2; }
bee::log_error() { echo "🔴 $*" >&2; }
bee::env() { echo "${!1}"; }

BEE_SYSTEM_HOME="${BASH_SOURCE[0]}"
while [[ -L "${BEE_SYSTEM_HOME}" ]]; do
  BEE_SYSTEM_HOME="$(readlink "${BEE_SYSTEM_HOME}")"
done
BEE_SYSTEM_HOME="$(cd "$(dirname "${BEE_SYSTEM_HOME}")/.." && pwd)"

[[ ! -f "${BEE_RC:="${HOME}/.beerc"}" ]] && cat << 'EOF' > "${BEE_RC}"
BEE_HUBS=(https://github.com/sschmid/beehub.git)
EOF
source "${BEE_RC}"

if [[ -v BEE_FILE ]]; then source "${BEE_FILE}"
elif [[ -f "Beefile" ]]; then BEE_FILE="Beefile"; source "${BEE_FILE}"; fi

if [[ -v BEE_VERSION ]]; then
  BEE_HOME="${BEE_CACHES_PATH}/bee/${BEE_VERSION}"
  [[ ! -d "${BEE_HOME}" ]] &&
    git -c advice.detachedHead=false clone -q --depth 1 --branch "${BEE_VERSION}" "${BEE_ORIGIN}" "${BEE_HOME}"
else
  BEE_HOME="${BEE_SYSTEM_HOME}"
fi

if [[ -f "${BEE_HOME}/src/os/${BEE_OSTYPE:=${OSTYPE%%[[:digit:]]*}}.bash" ]]; then
  source "${BEE_HOME}/src/os/${BEE_OSTYPE}.bash"
else
  source "${BEE_HOME}/src/os/generic.bash"
  bee::log_warn "Missing platform support for ${BEE_OSTYPE} (${OSTYPE})"
fi

source "${BEE_HOME}/src/bee-run.bash"
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  bee::run "$@"
fi
